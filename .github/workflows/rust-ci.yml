# Copyright (c) 2026 l5yth
# SPDX-License-Identifier: Apache-2.0

name: Rust CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cargo check
        run: cargo check --all --all-features

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Cargo test
        run: cargo test --all --all-features --verbose

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate lcov coverage
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          fail_ci_if_error: false

  archlinux-package:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install build dependencies
        run: pacman -Syu --noconfirm --needed base-devel git sudo rust

      - name: Build and install AUR package
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder "${GITHUB_WORKSPACE}"
          su - builder -c "cd '${GITHUB_WORKSPACE}/packaging/archlinux' && makepkg --syncdeps --noconfirm --cleanbuild --clean --install"

  gentoo-ebuild:
    runs-on: ubuntu-latest
    container:
      image: gentoo/stage3:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Bootstrap Gentoo repo and profile
        run: |
          mkdir -p /etc/portage/repos.conf
          cat > /etc/portage/repos.conf/gentoo.conf <<'EOF'
          [gentoo]
          location = /var/db/repos/gentoo
          sync-type = rsync
          sync-uri = rsync://rsync.gentoo.org/gentoo-portage
          auto-sync = yes
          EOF

          mkdir -p /var/db/repos/gentoo
          emerge --sync --quiet

          if [ ! -L /etc/portage/make.profile ]; then
            profile_path="$(find /var/db/repos/gentoo/profiles/default/linux/amd64 -type f -name make.defaults | head -n1)"
            if [ -n "${profile_path}" ]; then
              ln -snf "$(dirname "${profile_path}")" /etc/portage/make.profile
            fi
          fi

      - name: Configure local overlay
        run: |
          mkdir -p /var/db/repos/localrepo/{metadata,profiles,app-misc/lsu}
          cp "${GITHUB_WORKSPACE}/packaging/gentoo/app-misc/lsu/lsu-9999.ebuild" /var/db/repos/localrepo/app-misc/lsu/
          cp "${GITHUB_WORKSPACE}/packaging/gentoo/app-misc/lsu/metadata.xml" /var/db/repos/localrepo/app-misc/lsu/
          printf "localrepo\n" > /var/db/repos/localrepo/profiles/repo_name
          cat > /var/db/repos/localrepo/metadata/layout.conf <<'EOF'
          masters = gentoo
          auto-sync = no
          EOF
          mkdir -p /etc/portage/repos.conf
          cat > /etc/portage/repos.conf/localrepo.conf <<'EOF'
          [localrepo]
          location = /var/db/repos/localrepo
          masters = gentoo
          auto-sync = no
          EOF

      - name: Validate ebuild and resolve install plan
        run: |
          FEATURES="-ipc-sandbox -network-sandbox -pid-sandbox -mount-sandbox -usersandbox -userpriv" \
            ebuild /var/db/repos/localrepo/app-misc/lsu/lsu-9999.ebuild manifest
          FEATURES="-ipc-sandbox -network-sandbox -pid-sandbox -mount-sandbox -usersandbox -userpriv" \
            emerge -pv =app-misc/lsu-9999
